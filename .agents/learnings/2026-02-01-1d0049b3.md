# Learning: Zsh Alias Expansion Happens at Parse Time

**ID**: L1
**Category**: debugging
**Confidence**: high

## What We Learned

When using `eval "$(command)"` in zsh, the shell parses all content at once before executing any commands. This means `unalias history` followed by `history()` function definition will fail if the `history` alias exists - the alias expands during parsing before `unalias` runs. The fix is to use `function history { ... }` syntax, which explicitly declares a function without alias expansion.

## Why It Matters

Oh My Zsh and other frameworks commonly alias `history='fc -l'`, making this a real-world issue that "clean room" tests with `zsh -f` won't catch.

## Source

Session: 1d0049b3-8b3c-41ed-a866-a07ce4eed269

---

# Learning: $SHELL is Login Shell, Not Current Shell

**ID**: L2
**Category**: debugging
**Confidence**: high

## What We Learned

The `$SHELL` environment variable contains the user's login shell (from /etc/passwd), not the currently running shell. A user with zsh as login shell who opens bash will still have `$SHELL=/bin/zsh`. Shell integration scripts should export their own identifier (e.g., `CLAI_CURRENT_SHELL=bash`) to reliably detect which shell is active.

## Why It Matters

Commands like `clai doctor` and `clai status` need to report the correct shell-specific status, not the login shell's configuration.

## Source

Session: 1d0049b3-8b3c-41ed-a866-a07ce4eed269

---

# Learning: Test with eval, Not Just source

**ID**: L3
**Category**: testing
**Confidence**: high

## What We Learned

Shell integration scripts behave differently when loaded via `source file.sh` vs `eval "$(cat file.sh)"`. With `source`, each line is parsed and executed sequentially. With `eval`, the entire content is parsed first, then executed. This difference affects alias handling and can cause bugs only visible in production `eval "$(clai init zsh)"` patterns.

## Why It Matters

Tests using `source` alone may pass while real installations using `eval` fail.

## Source

Session: 1d0049b3-8b3c-41ed-a866-a07ce4eed269
