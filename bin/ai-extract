#!/bin/bash
# ai-extract - Extract suggested commands from terminal output
# Usage: some_command 2>&1 | ai-extract
#    or: ai-extract < output.txt

CACHE_DIR="${AI_TERMINAL_CACHE:-$HOME/.cache/ai-terminal}"
SUGGEST_FILE="$CACHE_DIR/suggestion"
LAST_OUTPUT_FILE="$CACHE_DIR/last_output"

# Ensure cache directory exists
mkdir -p "$CACHE_DIR"

# Read all input
OUTPUT=$(cat)

# Pass through the output so the user sees it
echo "$OUTPUT"

# Save for potential error analysis later
echo "$OUTPUT" > "$LAST_OUTPUT_FILE"

# Extract suggested commands using multiple patterns
SUGGESTED=""

# Pattern 1: Commands in backticks (most common)
# Matches: `npm install express`
if [[ -z "$SUGGESTED" ]]; then
    SUGGESTED=$(echo "$OUTPUT" | grep -oE '`[^`]+`' | tr -d '`' | grep -E '^[a-zA-Z]' | tail -1)
fi

# Pattern 2: Common install/run commands (even without backticks)
# Matches: pip install requests, npm install, brew install, etc.
if [[ -z "$SUGGESTED" ]]; then
    SUGGESTED=$(echo "$OUTPUT" | grep -oE '(pip3?|python3? -m pip|npm|yarn|pnpm|brew|cargo|go install|apt-get|apt|dnf|pacman -S) install [a-zA-Z0-9_@/.:=-]+( [a-zA-Z0-9_@/.:=-]+)*' | tail -1)
fi

# Pattern 3: "Run:" or "Execute:" or "Try:" prefixed commands
# Matches: Run: npm start, Try: python app.py
if [[ -z "$SUGGESTED" ]]; then
    SUGGESTED=$(echo "$OUTPUT" | grep -oiE '(run|execute|try|use):\s*[a-zA-Z][^\n]+' | sed -E 's/^(run|execute|try|use):\s*//i' | tail -1)
fi

# Pattern 4: Lines starting with $ (documentation examples)
# Matches: $ npm run dev
if [[ -z "$SUGGESTED" ]]; then
    SUGGESTED=$(echo "$OUTPUT" | grep -E '^\s*\$\s+' | sed -E 's/^\s*\$\s+//' | tail -1)
fi

# Pattern 5: "To install" or "To fix" followed by a command
# Matches: To install, run: npm install foo
if [[ -z "$SUGGESTED" ]]; then
    SUGGESTED=$(echo "$OUTPUT" | grep -oiE 'to (install|fix|run|start|build)[^:]*:\s*[a-zA-Z][^\n]+' | sed -E 's/^to [^:]+:\s*//i' | tail -1)
fi

# Write suggestion (or clear if none found)
if [[ -n "$SUGGESTED" ]]; then
    # Clean up: remove trailing punctuation, whitespace
    SUGGESTED=$(echo "$SUGGESTED" | sed -E 's/[.,;:]+$//' | xargs)
    echo "$SUGGESTED" > "$SUGGEST_FILE"
else
    # Clear the suggestion file
    > "$SUGGEST_FILE"
fi
