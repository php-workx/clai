#!/bin/bash
# ai-diagnose - Diagnose command errors using Claude Code CLI
# Usage: ai-diagnose "command" [exit_code]
#    or: ai-diagnose (uses last command from history)

set -e

CACHE_DIR="${AI_TERMINAL_CACHE:-$HOME/.cache/ai-terminal}"
LAST_OUTPUT_FILE="$CACHE_DIR/last_output"

# Colors
RED='\033[0;31m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
RESET='\033[0m'

# Get the command that failed
CMD="$1"
EXIT_CODE="${2:-1}"

if [[ -z "$CMD" ]]; then
    echo -e "${RED}Usage: ai-diagnose \"command\" [exit_code]${RESET}"
    echo -e "${DIM}Usually called automatically by the zsh integration.${RESET}"
    exit 1
fi

# Get error output from cache
if [[ -f "$LAST_OUTPUT_FILE" ]]; then
    ERROR_OUTPUT=$(tail -50 "$LAST_OUTPUT_FILE")
else
    ERROR_OUTPUT="(no output captured)"
fi

# Build the prompt for Claude
PROMPT="I ran this command in my terminal and it failed:

Command: $CMD
Exit code: $EXIT_CODE
Working directory: $(pwd)
Shell: ${SHELL##*/}
OS: $(uname -s)

Error output:
\`\`\`
$ERROR_OUTPUT
\`\`\`

Please:
1. Briefly explain what went wrong (1-2 sentences max)
2. Provide the corrected command to fix it

Be concise. Format as:
**Problem**: <explanation>
**Fix**: \`<corrected command>\`"

# Check if claude CLI is available
if ! command -v claude &> /dev/null; then
    echo -e "${RED}Error: 'claude' CLI not found.${RESET}"
    echo -e "${DIM}Install Claude Code: https://docs.anthropic.com/en/docs/claude-code${RESET}"
    exit 1
fi

# Call Claude
echo -e "${CYAN}━━━ AI Diagnosis ━━━${RESET}"
echo "$PROMPT" | claude --print 2>/dev/null || {
    echo -e "${RED}Failed to get response from Claude.${RESET}"
    exit 1
}
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━${RESET}"
