syntax = "proto3";
package clai.v1;

option go_package = "github.com/runger/clai/gen/proto/clai/v1;claiv1";

// ---------------------------------------------------------
// Common
// ---------------------------------------------------------

message ClientInfo {
  string version = 1;
  string os = 2;        // darwin, linux, windows
  string shell = 3;     // zsh, bash, pwsh
  string hostname = 4;  // machine hostname
  string username = 5;  // current user
}

message Ack {
  bool ok = 1;
  string error = 2;     // populated if ok=false
}

// ---------------------------------------------------------
// Session Lifecycle
// ---------------------------------------------------------

message SessionStartRequest {
  ClientInfo client = 1;
  string session_id = 2;          // UUID v4 generated by clai-shim
  string cwd = 3;
  int64 started_at_unix_ms = 4;
}

message SessionEndRequest {
  string session_id = 1;
  int64 ended_at_unix_ms = 2;
}

// ---------------------------------------------------------
// Command Lifecycle (Phase 1: No Output Capture)
// ---------------------------------------------------------

message CommandStartRequest {
  string session_id = 1;
  string command_id = 2;    // UUID v4
  int64 ts_unix_ms = 3;
  string cwd = 4;
  string command = 5;       // Raw command string
}

message CommandEndRequest {
  string session_id = 1;
  string command_id = 2;
  int64 ts_unix_ms = 3;
  int32 exit_code = 4;
  int64 duration_ms = 5;
  // NOTE: stdout/stderr fields removed for Phase 1 stability
}

// ---------------------------------------------------------
// Suggestions
// ---------------------------------------------------------

message SuggestRequest {
  string session_id = 1;
  string cwd = 2;
  string buffer = 3;        // Current typing buffer (prefix)
  int32 cursor_pos = 4;     // Cursor position in buffer
  bool include_ai = 5;      // Request AI suggestions (explicit trigger)
  int32 max_results = 6;    // Max suggestions to return (default: 5)
}

message Suggestion {
  string text = 1;              // The suggested command
  string description = 2;       // Optional description
  string source = 3;            // "session", "cwd", "global", "ai"
  double score = 4;             // Ranking score (0.0 to 1.0)
  string risk = 5;              // "safe", "destructive", or empty
}

message SuggestResponse {
  repeated Suggestion suggestions = 1;
  bool from_cache = 2;          // True if served from cache
}

// ---------------------------------------------------------
// Text-to-Command (AI)
// ---------------------------------------------------------

message TextToCommandRequest {
  string session_id = 1;
  string prompt = 2;            // Natural language prompt
  string cwd = 3;
  int32 max_suggestions = 4;    // Default: 3
}

message TextToCommandResponse {
  repeated Suggestion suggestions = 1;
  string provider = 2;          // Which AI provider was used
  int64 latency_ms = 3;         // AI response time
}

// ---------------------------------------------------------
// Next Step Prediction
// ---------------------------------------------------------

message NextStepRequest {
  string session_id = 1;
  string last_command = 2;
  int32 last_exit_code = 3;
  string cwd = 4;
}

message NextStepResponse {
  repeated Suggestion suggestions = 1;
}

// ---------------------------------------------------------
// Diagnosis
// ---------------------------------------------------------

message DiagnoseRequest {
  string session_id = 1;
  string command = 2;
  int32 exit_code = 3;
  string cwd = 4;
}

message DiagnoseResponse {
  string explanation = 1;       // Human-readable explanation
  repeated Suggestion fixes = 2; // Suggested fix commands
}

// ---------------------------------------------------------
// Status
// ---------------------------------------------------------

message StatusResponse {
  string version = 1;
  int32 active_sessions = 2;
  int64 uptime_seconds = 3;
  int64 commands_logged = 4;
}

// ---------------------------------------------------------
// Service
// ---------------------------------------------------------

service ClaiService {
  // Fire-and-Forget (Client ignores return)
  rpc SessionStart(SessionStartRequest) returns (Ack);
  rpc SessionEnd(SessionEndRequest) returns (Ack);
  rpc CommandStarted(CommandStartRequest) returns (Ack);
  rpc CommandEnded(CommandEndRequest) returns (Ack);

  // Interactive (Client waits with timeout)
  rpc Suggest(SuggestRequest) returns (SuggestResponse);
  rpc TextToCommand(TextToCommandRequest) returns (TextToCommandResponse);
  rpc NextStep(NextStepRequest) returns (NextStepResponse);
  rpc Diagnose(DiagnoseRequest) returns (DiagnoseResponse);

  // Ops
  rpc Ping(Ack) returns (Ack);
  rpc GetStatus(Ack) returns (StatusResponse);
}
